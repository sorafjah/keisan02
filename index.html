<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>計算プリント作成アプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
    }

    /* 印刷用のスタイル */
    @media print {
      /* 印刷時に不要な要素は非表示 */
      .no-print {
        display: none;
      }
      .page {
        box-shadow: none;
        margin: 0;
        border: none;
        width: 100%;
        /* ★★★ご指摘の通り、以前の成功した設定に戻します★★★ */
        height: auto;
        min-height: 0;
        page-break-inside: avoid;
      }
      #answer-sheet {
        page-break-before: always;
      }
    }

    .page {
      width: 210mm;
      /* 画面プレビュー用にA4の高さを設定 */
      min-height: 297mm;
      padding: 20mm 15mm 20mm 25mm;
      margin: 1rem auto;
      background: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
    }
    .problem-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      /* 行間をさらに広げ、16問でA4が埋まるように調整 */
      gap: 60px 20px;
      font-size: 1.5rem;
      line-height: 2.5;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">

  <div class="container mx-auto p-4 md:p-8">
    
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md no-print">
      <!-- 1. 問題設定 -->
      <section class="mb-6">
        <!-- 各問題の設定 -->
        <div id="problem-types" class="space-y-4">
            <!-- たしざん -->
            <div class="bg-gray-50 p-4 rounded-md border border-gray-200" id="add-block">
                <div class="flex items-baseline mb-3">
                    <span class="font-semibold">たしざん</span>
                    <p class="text-sm text-gray-600 ml-4">例：「7～9」+「8～16」の範囲で3問</p>
                </div>
                <div class="pl-6 space-y-3">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center">
                        <div class="flex items-center space-x-2">
                            <input type="number" id="add-min1" value="1" min="0" class="w-full p-2 border rounded">
                            <span>～</span>
                            <input type="number" id="add-max1" value="9" min="0" class="w-full p-2 border rounded">
                        </div>
                        <span class="text-2xl text-center font-bold">+</span>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="add-min2" value="1" min="0" class="w-full p-2 border rounded">
                            <span>～</span>
                            <input type="number" id="add-max2" value="9" min="0" class="w-full p-2 border rounded">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="add-count" class="whitespace-nowrap">問題数:</label>
                            <input type="number" id="add-count" value="0" min="0" max="16" class="w-full p-2 border rounded problem-count">
                        </div>
                    </div>
                     <div class="flex items-center gap-4">
                         <p class="text-sm font-medium whitespace-nowrap">問題の順番:</p>
                         <div class="flex space-x-4">
                             <label class="flex items-center gap-1"><input type="radio" name="add-order" value="sorted" checked> <span>小さい順</span></label>
                             <label class="flex items-center gap-1"><input type="radio" name="add-order" value="random"> <span>ランダム</span></label>
                         </div>
                     </div>
                </div>
            </div>
            <!-- ひき算 -->
            <div class="bg-gray-50 p-4 rounded-md border border-gray-200" id="sub-block">
                <div class="flex items-baseline mb-3">
                    <span class="font-semibold">ひき算</span>
                    <p class="text-sm text-gray-600 ml-4">例：「12～21」-「5～7」の範囲で4問</p>
                </div>
                <div class="pl-6 space-y-3">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center">
                         <div class="flex items-center space-x-2">
                            <input type="number" id="sub-min1" value="10" min="0" class="w-full p-2 border rounded">
                            <span>～</span>
                            <input type="number" id="sub-max1" value="20" min="0" class="w-full p-2 border rounded">
                        </div>
                        <span class="text-2xl text-center font-bold">-</span>
                         <div class="flex items-center space-x-2">
                            <input type="number" id="sub-min2" value="1" min="0" class="w-full p-2 border rounded">
                            <span>～</span>
                            <input type="number" id="sub-max2" value="9" min="0" class="w-full p-2 border rounded">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="sub-count" class="whitespace-nowrap">問題数:</label>
                            <input type="number" id="sub-count" value="0" min="0" max="16" class="w-full p-2 border rounded problem-count">
                        </div>
                    </div>
                     <div class="flex items-center gap-4">
                         <p class="text-sm font-medium whitespace-nowrap">問題の順番:</p>
                         <div class="flex space-x-4">
                             <label class="flex items-center gap-1"><input type="radio" name="sub-order" value="sorted" checked> <span>小さい順</span></label>
                             <label class="flex items-center gap-1"><input type="radio" name="sub-order" value="random"> <span>ランダム</span></label>
                         </div>
                     </div>
                </div>
            </div>
            <!-- かけ算 -->
            <div class="bg-gray-50 p-4 rounded-md border border-gray-200" id="mul-block">
                <div class="flex items-baseline mb-3">
                    <span class="font-semibold">かけ算</span>
                    <p class="text-sm text-gray-600 ml-4">例：段の範囲「5～7」× かける数の範囲「7～9」で3問</p>
                </div>
                <div class="pl-6 space-y-3">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center">
                         <div class="flex items-center space-x-2">
                            <input type="number" id="mul-min1" value="2" min="0" class="w-full p-2 border rounded">
                            <span>～</span>
                            <input type="number" id="mul-max1" value="9" min="0" class="w-full p-2 border rounded">
                        </div>
                        <span class="text-2xl text-center font-bold">×</span>
                         <div class="flex items-center space-x-2">
                            <input type="number" id="mul-min2" value="1" min="0" class="w-full p-2 border rounded">
                            <span>～</span>
                            <input type="number" id="mul-max2" value="9" min="0" class="w-full p-2 border rounded">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="mul-count" class="whitespace-nowrap">問題数:</label>
                            <input type="number" id="mul-count" value="0" min="0" max="16" class="w-full p-2 border rounded problem-count">
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                         <p class="text-sm font-medium whitespace-nowrap">問題の順番:</p>
                         <div class="flex space-x-4">
                             <label class="flex items-center gap-1"><input type="radio" name="mul-order" value="sorted" checked> <span>小さい順</span></label>
                             <label class="flex items-center gap-1"><input type="radio" name="mul-order" value="random"> <span>ランダム</span></label>
                         </div>
                     </div>
                </div>
            </div>
        </div>

        <div class="mt-6">
            <h3 class="font-semibold mb-2">問題の表示順</h3>
            <div class="flex flex-col md:flex-row md:space-x-6">
                <label><input type="radio" name="global-order" value="created" checked> 作ったままの順</label>
                <label><input type="radio" name="global-order" value="random"> 全ジャンルでランダム</label>
            </div>
        </div>

        <div id="error-message" class="text-red-500 font-bold mt-4 text-center"></div>
      </section>

      <!-- 3. プリントのレイアウトと出力設定 -->
      <section class="mb-6">
        <div class="flex items-center">
            <label for="header-text" class="font-semibold mr-4 whitespace-nowrap">右上テキスト:</label>
            <input type="text" id="header-text" class="w-full p-2 border rounded" placeholder="例：10月13日 かけ算7の段">
        </div>
      </section>

      <div class="text-center">
        <button id="create-button" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors text-lg">
          プリント作成
        </button>
      </div>
    </div>
    
    <!-- プリントプレビューエリア -->
    <div id="print-preview" class="hidden mt-10">
      <div class="print-area">
        <!-- 問題用紙 -->
        <div id="problem-sheet" class="page">
          <header class="flex justify-between items-center mb-8 pb-2">
            <span class="text-lg">なまえ＿＿＿＿＿＿＿＿＿＿＿＿</span>
            <span id="header-text-display" class="text-lg"></span>
          </header>
          <div id="problem-grid-display" class="problem-grid"></div>
        </div>
        <!-- 解答用紙 -->
        <div id="answer-sheet" class="page">
           <header class="flex justify-between items-center mb-8 pb-2">
            <span class="text-lg font-bold">こたえ</span>
            <span id="header-text-display-ans" class="text-lg"></span>
          </header>
          <div id="answer-grid-display" class="problem-grid"></div>
        </div>
      </div>
       <div class="text-center mt-4 no-print">
        <button id="print-button" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
          印刷する
        </button>
      </div>
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const problemCounts = document.querySelectorAll('.problem-count');
      const errorMessage = document.getElementById('error-message');
      const createButton = document.getElementById('create-button');

      const updateTotalCount = () => {
        let total = 0;
        problemCounts.forEach(input => {
          total += parseInt(input.value) || 0;
        });

        if (total > 16) {
          errorMessage.textContent = `エラー: 合計問題数が16問を超えています。（現在 ${total} 問）問題数を16問以下にしてください。`;
          createButton.disabled = true;
          createButton.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          errorMessage.textContent = '';
          createButton.disabled = false;
          createButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      };
      
      problemCounts.forEach(input => input.addEventListener('input', updateTotalCount));

      createButton.addEventListener('click', () => {
        let allProblems = [];

        if (parseInt(document.getElementById('add-count').value) > 0) {
          const config = {
            type: 'add',
            op: '+',
            min1: parseInt(document.getElementById('add-min1').value),
            max1: parseInt(document.getElementById('add-max1').value),
            min2: parseInt(document.getElementById('add-min2').value),
            max2: parseInt(document.getElementById('add-max2').value),
            count: parseInt(document.getElementById('add-count').value),
            order: document.querySelector('input[name="add-order"]:checked').value
          };
          allProblems.push(...generateProblems(config));
        }

        if (parseInt(document.getElementById('sub-count').value) > 0) {
          const config = {
            type: 'sub',
            op: '-',
            min1: parseInt(document.getElementById('sub-min1').value),
            max1: parseInt(document.getElementById('sub-max1').value),
            min2: parseInt(document.getElementById('sub-min2').value),
            max2: parseInt(document.getElementById('sub-max2').value),
            count: parseInt(document.getElementById('sub-count').value),
            order: document.querySelector('input[name="sub-order"]:checked').value
          };
          allProblems.push(...generateProblems(config));
        }

        if (parseInt(document.getElementById('mul-count').value) > 0) {
          const config = {
            type: 'mul',
            op: '×',
            min1: parseInt(document.getElementById('mul-min1').value),
            max1: parseInt(document.getElementById('mul-max1').value),
            min2: parseInt(document.getElementById('mul-min2').value),
            max2: parseInt(document.getElementById('mul-max2').value),
            count: parseInt(document.getElementById('mul-count').value),
            order: document.querySelector('input[name="mul-order"]:checked').value
          };
          allProblems.push(...generateProblems(config));
        }
        
        const globalOrder = document.querySelector('input[name="global-order"]:checked').value;
        if (globalOrder === 'random') {
            shuffleArray(allProblems);
        }

        renderPrint(allProblems);
      });

      document.getElementById('print-button').addEventListener('click', () => {
        window.print();
      });

      const generateProblems = (config) => {
        let problems = [];
        let combinations = new Set();
        
        if (config.type === 'mul' && config.order === 'sorted') {
             let allCombinations = [];
             for (let i = config.min1; i <= config.max1; i++) {
                 for (let j = config.min2; j <= config.max2; j++) {
                     allCombinations.push({num1: i, num2: j});
                 }
             }
             shuffleArray(allCombinations);
             const selected = allCombinations.slice(0, config.count);
             problems = selected.map(p => createProblemObject(config, p.num1, p.num2));

        } else {
            let attempt = 0;
            while (problems.length < config.count && attempt < 1000) {
              const num1 = getRandomInt(config.min1, config.max1);
              const num2 = getRandomInt(config.min2, config.max2);
              const key = `${num1},${num2}`;
              
              if (!combinations.has(key)) {
                // 引き算で答えが負にならないようにする
                if(config.type === 'sub' && num1 < num2) {
                    attempt++;
                    continue;
                }
                combinations.add(key);
                problems.push(createProblemObject(config, num1, num2));
              }
              attempt++;
            }
        }
        
        if (config.order === 'sorted') {
          problems.sort((a, b) => a.num1 - b.num1 || a.num2 - b.num2);
        }
        
        return problems;
      };

      const createProblemObject = (config, num1, num2) => {
          let answer;
          if (config.type === 'add') answer = num1 + num2;
          if (config.type === 'sub') answer = num1 - num2;
          if (config.type === 'mul') answer = num1 * num2;
          
          return {
              num1,
              num2,
              question: `${num1} ${config.op} ${num2}`,
              answer,
              type: config.type,
          };
      };

      const renderPrint = (problems) => {
        const problemGrid = document.getElementById('problem-grid-display');
        const answerGrid = document.getElementById('answer-grid-display');
        problemGrid.innerHTML = '';
        answerGrid.innerHTML = '';
        
        const headerText = document.getElementById('header-text').value;
        document.getElementById('header-text-display').textContent = headerText;
        document.getElementById('header-text-display-ans').textContent = headerText;


        problems.forEach(p => {
          const problemEl = document.createElement('div');
          problemEl.textContent = p.question;
          problemGrid.appendChild(problemEl);
          
          const answerEl = document.createElement('div');
          answerEl.textContent = `${p.question} = ${p.answer}`;
          answerGrid.appendChild(answerEl);
        });
        
        const printPreview = document.getElementById('print-preview');
        printPreview.classList.remove('hidden');
        printPreview.scrollIntoView({ behavior: 'smooth' });
      };

      const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

      const shuffleArray = (array) => {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      };
      
      updateTotalCount();
    });
  </script>

</body>

</html>

