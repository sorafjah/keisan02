<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>計算プリント作成アプリ2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', 'Inter', sans-serif;
        }

        /* A4印刷用のスタイル */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-container, #print-container * {
                visibility: visible;
            }
            #print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
            }
            #controls, #settings-container {
                display: none;
            }
        }
        
        #print-sheet {
            width: 210mm;
            height: 297mm;
            box-sizing: border-box;
            margin: 0 auto;
            /* page-break-after: always; を削除 */
        }

        .problem-item {
            font-size: 1.5rem; /* 24px */
            line-height: 2rem; /* 32px */
            letter-spacing: 0.1em;
            padding: 1rem 0; /* 上下のパディングを調整 */
            text-align: left; /* 左揃えに変更 */
            font-variant-numeric: tabular-nums; /* 数字の幅を揃える */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div id="settings-container" class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-lg">
        <h1 class="text-2xl md:text-3xl font-bold mb-6 text-center text-gray-700">計算プリント作成アプリ 2</h1>
        
        <form id="settings-form">
            <h2 class="text-xl font-bold mb-4 border-b-2 border-blue-500 pb-2">1. 問題設定</h2>
            <p class="text-gray-600 mb-6">作成したい問題の種類、範囲、問題数を指定してください。複数の種類を組み合わせることも可能です。</p>

            <!-- 足し算 -->
            <div class="bg-blue-50 p-4 rounded-xl mb-6 border border-blue-200">
                <h3 class="text-lg font-bold text-blue-800 mb-4">足し算</h3>
                <div class="flex flex-col md:flex-row md:items-center md:gap-4 space-y-4 md:space-y-0">
                    <div class="flex flex-wrap items-center gap-2 flex-grow">
                        <input type="number" id="add-min1" min="0" class="w-16 p-2 border rounded-lg" value="7">
                        <span>〜</span>
                        <input type="number" id="add-max1" min="0" class="w-16 p-2 border rounded-lg" value="9">
                        <span class="text-2xl font-bold mx-2">+</span>
                        <input type="number" id="add-min2" min="0" class="w-16 p-2 border rounded-lg" value="8">
                        <span>〜</span>
                        <input type="number" id="add-max2" min="0" class="w-16 p-2 border rounded-lg" value="16">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="add-count" class="font-semibold whitespace-nowrap">問題数:</label>
                        <input type="number" id="add-count" min="0" class="w-20 p-2 border rounded-lg" value="3">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-semibold whitespace-nowrap">順番:</span>
                        <label><input type="radio" name="add-order" value="asc" checked> 小さい順</label>
                        <label><input type="radio" name="add-order" value="random"> ランダム</label>
                    </div>
                </div>
            </div>

            <!-- 引き算 -->
            <div class="bg-green-50 p-4 rounded-xl mb-6 border border-green-200">
                <h3 class="text-lg font-bold text-green-800 mb-4">引き算</h3>
                <div class="flex flex-col md:flex-row md:items-center md:gap-4 space-y-4 md:space-y-0">
                    <div class="flex flex-wrap items-center gap-2 flex-grow">
                        <input type="number" id="sub-min1" min="0" class="w-16 p-2 border rounded-lg" value="12">
                        <span>〜</span>
                        <input type="number" id="sub-max1" min="0" class="w-16 p-2 border rounded-lg" value="21">
                        <span class="text-2xl font-bold mx-2">-</span>
                        <input type="number" id="sub-min2" min="0" class="w-16 p-2 border rounded-lg" value="5">
                        <span>〜</span>
                        <input type="number" id="sub-max2" min="0" class="w-16 p-2 border rounded-lg" value="7">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="sub-count" class="font-semibold whitespace-nowrap">問題数:</label>
                        <input type="number" id="sub-count" min="0" class="w-20 p-2 border rounded-lg" value="4">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-semibold whitespace-nowrap">順番:</span>
                        <label><input type="radio" name="sub-order" value="asc" checked> 小さい順</label>
                        <label><input type="radio" name="sub-order" value="random"> ランダム</label>
                    </div>
                </div>
            </div>

            <!-- かけ算 -->
            <div class="bg-yellow-50 p-4 rounded-xl mb-6 border border-yellow-200">
                 <h3 class="text-lg font-bold text-yellow-800 mb-4">かけ算</h3>
                 <div class="flex flex-col md:flex-row md:items-center md:gap-4 space-y-4 md:space-y-0">
                    <div class="flex flex-wrap items-center gap-2 flex-grow">
                        <input type="number" id="mul-min1" min="0" class="w-16 p-2 border rounded-lg" value="5">
                        <span>〜</span>
                        <input type="number" id="mul-max1" min="0" class="w-16 p-2 border rounded-lg" value="7">
                        <span class="text-2xl font-bold mx-2">×</span>
                        <span>かける数:</span>
                        <input type="number" id="mul-min2" min="0" class="w-16 p-2 border rounded-lg" value="7">
                        <span>〜</span>
                        <input type="number" id="mul-max2" min="0" class="w-16 p-2 border rounded-lg" value="9">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="mul-count" class="font-semibold whitespace-nowrap">問題数:</label>
                        <input type="number" id="mul-count" min="0" class="w-20 p-2 border rounded-lg" value="3">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-semibold whitespace-nowrap">順番:</span>
                        <label><input type="radio" name="mul-order" value="asc" checked> 小さい順</label>
                        <label><input type="radio" name="mul-order" value="random"> ランダム</label>
                    </div>
                </div>
            </div>

            <div class="p-6 rounded-xl mb-6 border border-gray-200">
                <h3 class="text-lg font-bold mb-4">問題の表示順</h3>
                <div class="flex flex-col md:flex-row gap-4">
                    <label class="flex-1"><input type="radio" name="overall-order" value="as-created" checked> 作ったままの順</label>
                    <label class="flex-1"><input type="radio" name="overall-order" value="grouped"> ジャンルごとに固める</label>
                    <label class="flex-1"><input type="radio" name="overall-order" value="random"> 全ジャンルでランダム</label>
                </div>
            </div>

            <div class="p-6 rounded-xl mb-6 border border-gray-200">
                <h3 class="text-lg font-bold mb-4">ヘッダー右上のテキスト</h3>
                <input type="text" id="header-text" class="w-full p-2 border rounded-lg" placeholder="例：たしざんとかけ算7の段">
            </div>

            <div id="error-message" class="text-red-600 font-bold text-center my-4 hidden"></div>

            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors text-xl">
                プリント作成
            </button>
        </form>
    </div>

    <div id="print-container" class="hidden">
        <div id="controls" class="max-w-4xl mx-auto mb-4 flex justify-center gap-4">
            <button id="back-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">設定に戻る</button>
            <button id="answer-toggle-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">こたえ表示</button>
            <button id="print-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">印刷する</button>
        </div>
        
        <div id="print-sheet" class="bg-white p-8 shadow-lg">
             <div class="flex justify-between items-center text-lg mb-8 gap-4">
                <div class="flex items-end flex-grow-[2]">
                    <span class="whitespace-nowrap font-semibold">なまえ</span>
                    <span class="w-full border-b-2 border-gray-500 ml-3 mb-1"></span>
                </div>
                <span id="header-text-display" class="text-right flex-grow-[1]"></span>
            </div>
            <div id="problems-display" class="grid grid-cols-2 gap-x-16 pl-9">
                <!-- 問題がここに挿入されます -->
            </div>
        </div>
    </div>


    <script>
        const settingsForm = document.getElementById('settings-form');
        const settingsContainer = document.getElementById('settings-container');
        const printContainer = document.getElementById('print-container');
        const errorMessage = document.getElementById('error-message');
        const backBtn = document.getElementById('back-btn');
        const answerToggleBtn = document.getElementById('answer-toggle-btn');
        const printBtn = document.getElementById('print-btn');
        const problemsDisplay = document.getElementById('problems-display');
        const headerTextDisplay = document.getElementById('header-text-display');

        let problems = [];
        let showingAnswers = false;
        
        // ユーティリティ関数
        const getVal = id => parseInt(document.getElementById(id).value, 10) || 0;
        const getRadio = name => document.querySelector(`input[name="${name}"]:checked`).value;
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        // 配列をシャッフルする
        const shuffle = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        const generateProblems = () => {
            const allProblemGroups = [];
            
            // 足し算
            const addCount = getVal('add-count');
            if (addCount > 0) {
                let addProblems = [];
                let [min1, max1] = [getVal('add-min1'), getVal('add-max1')];
                let [min2, max2] = [getVal('add-min2'), getVal('add-max2')];
                if (min1 > max1) [min1, max1] = [max1, min1];
                if (min2 > max2) [min2, max2] = [max2, min2];
                
                let attempts = 0;
                while(addProblems.length < addCount && attempts < 1000){
                    const n1 = randInt(min1, max1);
                    const n2 = randInt(min2, max2);
                    const newProblem = { n1, n2, type: '+', answer: n1 + n2 };
                    if (!addProblems.some(p => p.n1 === n1 && p.n2 === n2)) {
                         addProblems.push(newProblem);
                    }
                    attempts++;
                }

                if (getRadio('add-order') === 'asc') {
                    addProblems.sort((a, b) => a.n1 - b.n1 || a.n2 - b.n2);
                } else {
                    addProblems = shuffle(addProblems);
                }
                allProblemGroups.push({type: 'add', problems: addProblems});
            }

            // 引き算
            const subCount = getVal('sub-count');
            if (subCount > 0) {
                 let subProblems = [];
                let [min1, max1] = [getVal('sub-min1'), getVal('sub-max1')];
                let [min2, max2] = [getVal('sub-min2'), getVal('sub-max2')];
                if (min1 > max1) [min1, max1] = [max1, min1];
                if (min2 > max2) [min2, max2] = [max2, min2];
                
                let attempts = 0;
                while(subProblems.length < subCount && attempts < 1000){
                    let n1 = randInt(min1, max1);
                    let n2 = randInt(min2, max2);
                    if (n1 < n2) [n1, n2] = [n2, n1]; // 答えが負にならないように
                    
                    const newProblem = { n1, n2, type: '-', answer: n1 - n2 };
                    if (!subProblems.some(p => p.n1 === n1 && p.n2 === n2)) {
                         subProblems.push(newProblem);
                    }
                    attempts++;
                }


                if (getRadio('sub-order') === 'asc') {
                    subProblems.sort((a, b) => a.n1 - b.n1 || a.n2 - b.n2);
                } else {
                    subProblems = shuffle(subProblems);
                }
                allProblemGroups.push({type: 'sub', problems: subProblems});
            }

            // かけ算
            const mulCount = getVal('mul-count');
            if (mulCount > 0) {
                let mulProblems = [];
                let [min1, max1] = [getVal('mul-min1'), getVal('mul-max1')];
                let [min2, max2] = [getVal('mul-min2'), getVal('mul-max2')];
                if (min1 > max1) [min1, max1] = [max1, min1];
                if (min2 > max2) [min2, max2] = [max2, min2];
                
                let attempts = 0;
                while(mulProblems.length < mulCount && attempts < 1000){
                    const n1 = randInt(min1, max1);
                    const n2 = randInt(min2, max2);
                    const newProblem = { n1, n2, type: '×', answer: n1 * n2 };
                    if (!mulProblems.some(p => p.n1 === n1 && p.n2 === n2)) {
                         mulProblems.push(newProblem);
                    }
                    attempts++;
                }

                if (getRadio('mul-order') === 'asc') {
                    mulProblems.sort((a, b) => a.n1 - b.n1 || a.n2 - b.n2);
                } else {
                    mulProblems = shuffle(mulProblems);
                }
                allProblemGroups.push({type: 'mul', problems: mulProblems});
            }

            const overallOrder = getRadio('overall-order');
            let finalProblems = [];

            if (overallOrder === 'grouped') {
                 allProblemGroups.forEach(group => finalProblems.push(...group.problems));
            } else {
                // 'as-created' はこの順番
                let combined = allProblemGroups.reduce((acc, group) => acc.concat(group.problems), []);
                finalProblems = combined;
            }
            
            if (overallOrder === 'random') {
                finalProblems = shuffle(finalProblems);
            }
            
            return finalProblems;
        };

        const renderProblems = () => {
            problemsDisplay.innerHTML = '';
            
            // レイアウト調整
            problemsDisplay.style.alignContent = 'space-around';
            
            problems.forEach(p => {
                const problemEl = document.createElement('div');
                problemEl.classList.add('problem-item');

                const n1Str = String(p.n1).padStart(2, ' ');
                const n2Str = String(p.n2).padStart(2, ' ');

                if (showingAnswers) {
                    const ansStr = String(p.answer).padStart(3, ' ');
                    problemEl.innerHTML = `${n1Str} ${p.type} ${n2Str} = ${ansStr}`;
                } else {
                    problemEl.innerHTML = `${n1Str} ${p.type} ${n2Str}`;
                }
                 // テキストの代わりにinnerHTMLを使い、スペースを&nbsp;に置換して表示を維持
                problemEl.innerHTML = problemEl.innerHTML.replace(/ /g, '&nbsp;');

                problemsDisplay.appendChild(problemEl);
            });
        };

        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const totalCount = getVal('add-count') + getVal('sub-count') + getVal('mul-count');
            if (totalCount > 16) {
                errorMessage.textContent = 'エラー: 合計問題数が16問を超えています。問題数を16問以下にしてください。';
                errorMessage.classList.remove('hidden');
                return;
            }
             if (totalCount === 0) {
                errorMessage.textContent = 'エラー: 問題数を1問以上にしてください。';
                errorMessage.classList.remove('hidden');
                return;
            }
            errorMessage.classList.add('hidden');

            problems = generateProblems();

            headerTextDisplay.textContent = document.getElementById('header-text').value;

            settingsContainer.classList.add('hidden');
            printContainer.classList.remove('hidden');

            showingAnswers = false;
            answerToggleBtn.textContent = 'こたえ表示';
            answerToggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            answerToggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            renderProblems();
        });

        backBtn.addEventListener('click', () => {
            settingsContainer.classList.remove('hidden');
            printContainer.classList.add('hidden');
        });

        answerToggleBtn.addEventListener('click', () => {
            showingAnswers = !showingAnswers;
            if (showingAnswers) {
                answerToggleBtn.textContent = 'もんだい表示';
                answerToggleBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                answerToggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                answerToggleBtn.textContent = 'こたえ表示';
                answerToggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                answerToggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            }
            renderProblems();
        });
        
        printBtn.addEventListener('click', () => {
            window.print();
        });

    </script>
</body>
</html>

